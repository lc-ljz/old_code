function G(e,r){var l=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);r&&(i=i.filter(function(w){return Object.getOwnPropertyDescriptor(e,w).enumerable})),l.push.apply(l,i)}return l}function U(e){for(var r=1;r<arguments.length;r++){var l=arguments[r]!=null?arguments[r]:{};r%2?G(Object(l),!0).forEach(function(i){te(e,i,l[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(l)):G(Object(l)).forEach(function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(l,i))})}return e}function te(e,r,l){return r in e?Object.defineProperty(e,r,{value:l,enumerable:!0,configurable:!0,writable:!0}):e[r]=l,e}import a,{useCallback as W,useEffect as k,useMemo as j,useRef as x,useState as $}from"../../../web_modules/react.js";import{ellipsis as K,em as C,primaryColor as re,rem as f,size as ne,transitionProps as M}from"../../utils/style.js";import oe,{useRunningRequest as le}from"../../hooks/useRequest.js";import ie from"../ChartToolbox.js";import se from"../../../web_modules/react-spinners/GridLoader.js";import ae from"./StepSlider.js";import{fetcher as ce}from"../../utils/fetch.js";import{formatTime as me}from"../../utils/index.js";import V from"../../../web_modules/lodash/isEmpty.js";import ue from"../../../web_modules/mime-types.js";import B from"../../../web_modules/query-string.js";import{saveFile as de}from"../../utils/saveFile.js";import E from"../../../web_modules/styled-components.js";import{useTranslation as pe}from"../../../web_modules/react-i18next.js";const fe=E.div.withConfig({displayName:"SampleChart__Wrapper",componentId:"sc-19m7v01-0"})(["height:100%;padding:",";padding-bottom:0;display:flex;flex-direction:column;justify-content:flex-start;align-items:stretch;> *{flex-grow:0;flex-shrink:0;}"],C(20)),we=E.div.withConfig({displayName:"SampleChart__Title",componentId:"sc-19m7v01-1"})(["display:flex;justify-content:space-between;align-items:center;margin-bottom:",";> h4{font-size:",";font-weight:700;flex-shrink:1;flex-grow:1;padding:0;margin:0;","}> span{font-size:",";flex-shrink:0;flex-grow:0;color:var(--text-light-color);"," max-width:50%;"," &::before{content:'';display:inline-block;"," margin-right:",";border-radius:",";vertical-align:middle;background-color:",";}}"],C(20),C(16),K(),C(14),K(),M("color"),ne(f(5),f(17)),f(8),f(2.5),e=>e.color),ge=E.div.withConfig({displayName:"SampleChart__Container",componentId:"sc-19m7v01-2"})(["flex-grow:1;flex-shrink:1;margin:"," 0;display:flex;justify-content:center;align-items:center;overflow:hidden;cursor:",";"],C(20),e=>e.preview?"zoom-in":"default"),he=E.div.withConfig({displayName:"SampleChart__Footer",componentId:"sc-19m7v01-3"})(["margin-bottom:",";display:flex;align-items:center;justify-content:space-between;"],f(18)),ye=E.div.withConfig({displayName:"SampleChart__FooterInfo",componentId:"sc-19m7v01-4"})(["color:var(--text-lighter-color);font-size:",";"," > *{display:inline-block;margin-left:",";}"],f(12),M("color"),f(10));export const getEntityUrl=(e,r,l,i,w)=>`/${e}/${e}?${B.stringify({index:r,ts:w,run:l,tag:i})}`;const ve=({run:e,tag:r,running:l,type:i,cache:w,footer:H,renderContent:P,renderPreviewer:O})=>{const{t:g,i18n:J}=pe(["sample","common"]),{data:o,error:I,loading:R}=le(`/${i}/list?${B.stringify({run:e.label,tag:r})}`,!!l),u=j(()=>{var t;return(t=o==null?void 0:o.map(s=>s.step))!==null&&t!==void 0?t:[]},[o]),[S,D]=$(!1),[n,_]=$(0),[h,N]=$(),c=x({}),v=x(null),q=x(null);k(()=>{const t=s=>{const ee=document.querySelectorAll(":hover");(S||Array.from(ee).some(m=>m.isSameNode(q.current)))&&(s.key==="ArrowLeft"||s.key==="ArrowUp"?(_(m=>m>0?m-1:m),s.preventDefault()):(s.key==="ArrowRight"||s.key==="ArrowDown")&&(_(m=>m<u.length-1?m+1:m),s.preventDefault()))};return document.addEventListener("keydown",t),()=>document.removeEventListener("keydown",t)},[u,S]),k(()=>{Object.values(c.current).forEach(({timer:t})=>window.clearTimeout(t)),c.current={}},[r,e]);const b=j(()=>{var t;return(t=o==null?void 0:o[n].wallTime)!==null&&t!==void 0?t:0},[o,n]),y=W(()=>{if(!o)return;const t=getEntityUrl(i,n,e.label,r,b);c.current[n]={src:t,timer:window.setTimeout(()=>{(s=>delete c.current[s])(n)},w)},N(t),v.current=null},[i,n,e.label,r,b,o,w]);k(()=>{if(c.current[n])N(c.current[n].src);else if(V(c.current))y();else return v.current=window.setTimeout(y,500),()=>{v.current!=null&&(window.clearTimeout(v.current),v.current=null)}},[n,y]);const[z,Q]=$(!1),T=x(null),A=x(new IntersectionObserver(t=>{if(t[0].intersectionRatio>0){var s;Q(!0),(s=A.current)===null||s===void 0||s.disconnect()}}));k(()=>{const t=A.current;if(T.current&&t)return t.observe(T.current),()=>t.disconnect()},[]);const{data:d,error:F,loading:L}=oe(h!=null?h:null,ce,{dedupingInterval:5*60*1e3}),X=W(()=>{if(d){const t=d.type?ue.extension(d.type):null;de(d.data,`${e.label}-${r}-${u[n]}-${b}`+(t?`.${t}`:""))}},[d,e.label,r,u,n,b]),p=j(()=>{if(h)return{data:d,error:F,loading:L}},[h,d,F,L]),Y=j(()=>R||!c.current[n]||!z?a.createElement(se,{color:re,size:"10px"}):!o&&I?a.createElement("span",null,g("common:error")):V(o)?a.createElement("span",null,g("common:empty")):p?P(p):null,[z,R,I,o,n,p,g,P]),Z=j(()=>!O||!S||!p?null:O(U(U({},p),{},{loading:!c.current[n]||p.loading,steps:u,step:n,onClose:()=>D(!1),onChange:_,onChangeComplete:y})),[O,p,S,u,n,y]);return a.createElement(fe,{ref:q},a.createElement(we,{color:e.colors[0]},a.createElement("h4",null,r),a.createElement("span",null,e.label)),a.createElement(ae,{value:n,steps:u,onChange:_,onChangeComplete:y},me(b,J.language)),a.createElement(ge,{ref:T,preview:!!O&&!!h,onClick:()=>D(!0)},Y),Z,a.createElement(he,null,a.createElement(ie,{items:[{icon:"download",tooltip:g(`sample:download-${i}`),onClick:X}]}),a.createElement(ye,null,a.createElement("span",null,g("sample:sample"),g("common:colon"),o!=null&&o.length?`${n+1}/${o.length}`:"--/--"),H)))};export default ve;
