function E(){return E=Object.assign||function(o){for(var n=1;n<arguments.length;n++){var e=arguments[n];for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(o[i]=e[i])}return o},E.apply(this,arguments)}function F(o,n){var e=Object.keys(o);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(o);n&&(i=i.filter(function(c){return Object.getOwnPropertyDescriptor(o,c).enumerable})),e.push.apply(e,i)}return e}function X(o){for(var n=1;n<arguments.length;n++){var e=arguments[n]!=null?arguments[n]:{};n%2?F(Object(e),!0).forEach(function(i){nt(o,i,e[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(o,Object.getOwnPropertyDescriptors(e)):F(Object(e)).forEach(function(i){Object.defineProperty(o,i,Object.getOwnPropertyDescriptor(e,i))})}return o}function nt(o,n,e){return n in o?Object.defineProperty(o,n,{value:e,enumerable:!0,configurable:!0,writable:!0}):o[n]=e,o}import it from"../LineChart.js";import{Modes as m,options as at}from"../../resource/histogram/index.js";import s,{useCallback as Z,useEffect as st,useMemo as f,useRef as lt,useState as W}from"../../../web_modules/react.js";import mt from"../StackChart.js";import{rem as h,size as Y}from"../../utils/style.js";import P from"../Chart.js";import{Chart as $}from"../Loader/ChartPage.js";import ct from"../ChartToolbox.js";import{distance as ut}from"../../utils/index.js";import{fetcher as ft}from"../../utils/fetch.js";import{format as M}from"../../../web_modules/d3-format.js";import dt from"../../../web_modules/lodash/minBy.js";import ht from"../../../web_modules/query-string.js";import p from"../../../web_modules/styled-components.js";import{useRunningRequest as pt}from"../../hooks/useRequest.js";import gt from"../../hooks/useThrottleFn.js";import{useTranslation as vt}from"../../../web_modules/react-i18next.js";import yt from"../../hooks/useWebAssembly.js";const V=M(".4f"),B=M(".4"),xt=p.div.withConfig({displayName:"HistogramChart__Wrapper",componentId:"sc-1nqqqkz-0"})([""," display:flex;flex-direction:column;align-items:stretch;justify-content:space-between;"],Y("100%","100%")),bt=p(it).withConfig({displayName:"HistogramChart__StyledLineChart",componentId:"sc-1nqqqkz-1"})(["flex-grow:1;"]),Ot=p(mt).withConfig({displayName:"HistogramChart__StyledStackChart",componentId:"sc-1nqqqkz-2"})(["flex-grow:1;"]),wt=p(ct).withConfig({displayName:"HistogramChart__Toolbox",componentId:"sc-1nqqqkz-3"})(["margin-left:",";margin-right:",";margin-bottom:",";"],h(20),h(20),h(18)),jt=p.div.withConfig({displayName:"HistogramChart__Error",componentId:"sc-1nqqqkz-4"})([""," display:flex;justify-content:center;align-items:center;"],Y("100%","100%")),d={width:430,height:337},I={width:h(d.width),height:h(d.height)},Ct=({run:o,tag:n,mode:e,running:i})=>{const{t:c}=vt(["histogram","common"]),y=lt(null),{data:g,error:K,loading:x}=pt(`/histogram/list?${ht.stringify({run:o.label,tag:n})}`,!!i,ft,{refreshInterval:60*1e3}),[G,J]=W(!1),b=f(()=>`${n} (${o.label})`,[n,o.label]),Q=f(()=>[g!=null?g:[],e],[g,e]),{data:a}=yt("histogram_transform",Q),[u,O]=W(null);st(()=>O(null),[e]);const w=f(()=>{if(e===m.Overlay)return a==null?void 0:a.data.map((t,l)=>({name:`${c("common:time-mode.step")}${t[0][1]}`,data:t,lineStyle:{color:o.colors[l===u||u==null?0:1]},z:l===u?a==null?void 0:a.data.length:l,encode:{x:[2],y:[3]}}));if(e===m.Offset){var r;const t=a;return{minX:t==null?void 0:t.minX,maxX:t==null?void 0:t.maxX,minY:t==null?void 0:t.minStep,maxY:t==null?void 0:t.maxStep,minZ:t==null?void 0:t.minZ,maxZ:t==null?void 0:t.maxZ,data:(r=t==null?void 0:t.data)!==null&&r!==void 0?r:[]}}return null},[a,e,o,u,c]),T=f(()=>({[m.Overlay]:r=>{var t;if(!a||u==null)return"";const l=r.find(v=>v.data[1]===a.data[u][0][1]);return(t=l==null?void 0:l.seriesName)!==null&&t!==void 0?t:""},[m.Offset]:r=>r[2]}),[u,a]),k=f(()=>({[m.Overlay]:r=>r.axisDimension==="x"?V(r.value):r.axisDimension==="y"?B(r.value):"",[m.Offset]:(r,t)=>r.axisDimension==="x"?V(t==null?void 0:t[0]):r.axisDimension==="y"?B(t==null?void 0:t[1]):""}),[]),j=f(()=>X(X({},at[e]),{},{color:[o.colors[0]],tooltip:{formatter:T[e]},axisPointer:{label:{formatter:k[e]}},xAxis:{axisPointer:{snap:e===m.Overlay}},yAxis:{axisPointer:{snap:e===m.Overlay}}}),[e,o,T,k]),U=Z((r,{offsetX:t,offsetY:l})=>{const v=r.getOption().series,et=[t,l];if(v){var _;const rt=v.map((S,D)=>{var z;return(z=S.data)===null||z===void 0?void 0:z.reduce((H,[,,L,R])=>{const ot=r.convertToPixel("grid",[L,R]),A=ut(ot,et);return A<H[2]?[L,R,A,D]:H},[0,0,Number.POSITIVE_INFINITY,D])}),q=dt(rt,S=>S[2]);O((_=q==null?void 0:q[3])!==null&&_!==void 0?_:null);return}},[]),C=gt(U,{wait:200}),N=Z(r=>{const t=r.getZr();t&&(t.on("mousemove",l=>C.run(r,l)),t.on("mouseout",()=>{C.cancel(),O(null)}))},[C]),tt=f(()=>e===m.Overlay?s.createElement(bt,{ref:y,title:b,data:w,options:j,loading:x,onInit:N}):e===m.Offset?s.createElement(Ot,{ref:y,title:b,data:w,options:j,loading:x}):null,[w,x,e,j,b,N]);return!a&&K?s.createElement(jt,null,c("common:error")):s.createElement(P,E({maximized:G},I),s.createElement(xt,null,tt,s.createElement(wt,{items:[{icon:"maximize",activeIcon:"minimize",tooltip:c("histogram:maximize"),activeTooltip:c("histogram:minimize"),toggle:!0,onClick:()=>J(r=>!r)},{icon:"download",tooltip:c("histogram:download-image"),onClick:()=>{var r;return(r=y.current)===null||r===void 0?void 0:r.saveAsImage()}}]})))};export default Ct;export const Loader=()=>s.createElement(s.Fragment,null,s.createElement(P,I,s.createElement($,{width:d.width-2,height:d.height-2})),s.createElement(P,I,s.createElement($,{width:d.width-2,height:d.height-2})));
