import $e from"../../__snowpack__/env.js";import.meta.env=$e;function me(o,i){var l=Object.keys(o);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(o);i&&(s=s.filter(function(g){return Object.getOwnPropertyDescriptor(o,g).enumerable})),l.push.apply(l,s)}return l}function q(o){for(var i=1;i<arguments.length;i++){var l=arguments[i]!=null?arguments[i]:{};i%2?me(Object(l),!0).forEach(function(s){Ve(o,s,l[s])}):Object.getOwnPropertyDescriptors?Object.defineProperties(o,Object.getOwnPropertyDescriptors(l)):me(Object(l)).forEach(function(s){Object.defineProperty(o,s,Object.getOwnPropertyDescriptor(l,s))})}return o}function Ve(o,i,l){return i in o?Object.defineProperty(o,i,{value:l,enumerable:!0,configurable:!0,writable:!0}):o[i]=l,o}import Ue,{AsideSection as O}from"../components/Aside.js";import We from"../components/HighDimensionalPage/HighDimensionalChart.js";import qe from"../components/HighDimensionalPage/LabelSearchInput.js";import t,{useCallback as b,useEffect as h,useMemo as d,useRef as Ke,useState as a}from"../../web_modules/react.js";import Xe from"../components/Select.js";import ze from"../components/BodyLoading.js";import Ye from"../components/Button.js";import Ge from"../components/Content.js";import Je from"../components/HighDimensionalPage/DimensionSwitch.js";import Qe from"../components/Error.js";import p from"../components/Field.js";import Ze from"../components/HighDimensionalPage/LabelSearchResult.js";import et from"../components/HighDimensionalPage/PCADetail.js";import tt from"../components/HighDimensionalPage/ReductionTab.js";import nt from"../components/HighDimensionalPage/TSNEDetail.js";import ot from"../components/Title.js";import at from"../components/HighDimensionalPage/UMAPDetail.js";import it from"../components/HighDimensionalPage/UploadDialog.js";import ue from"../../web_modules/query-string.js";import{rem as K}from"../utils/style.js";import _ from"../../web_modules/styled-components.js";import{toast as X}from"../../web_modules/react-toastify.js";import z from"../hooks/useRequest.js";import{useTranslation as lt}from"../../web_modules/react-i18next.js";import rt from"../hooks/useWorker.js";const st=import.meta.env.MODE,ct={pca:5e4,tsne:1e4,umap:5e3},dt={pca:200,tsne:void 0,umap:void 0},mt=_.div.withConfig({displayName:"high-dimensional__AsideTitle",componentId:"kunowy-0"})(["font-size:",";line-height:",";font-weight:700;margin-bottom:",";"],K(16),K(16),K(20)),he=_(Xe).withConfig({displayName:"high-dimensional__FullWidthSelect",componentId:"kunowy-1"})(["width:100%;"]),ut=_(Ye).withConfig({displayName:"high-dimensional__FullWidthButton",componentId:"kunowy-2"})(["width:100%;"]),pe=_(Ue).withConfig({displayName:"high-dimensional__HDAside",componentId:"kunowy-3"})([".secondary{color:var(--text-light-color);}"]),ht=_(pe).withConfig({displayName:"high-dimensional__RightAside",componentId:"kunowy-4"})(["border-left:1px solid var(--border-color);"]),pt=_(pe).withConfig({displayName:"high-dimensional__LeftAside",componentId:"kunowy-5"})(["border-right:1px solid var(--border-color);","{border-bottom:none;}> .aside-top > .search-result{margin-top:0;margin-left:0;margin-right:0;flex:auto;overflow:hidden auto;}"],O),gt=_(Ge).withConfig({displayName:"high-dimensional__HDContent",componentId:"kunowy-6"})(["background-color:var(--background-color);"]),ft=()=>{const{t:o}=lt(["high-dimensional","common"]),i=Ke(null),{data:l,loading:s}=z("/embedding/list"),g=d(()=>{var e;return(e=l==null?void 0:l.map(n=>q({value:n.name,label:n.name},n)))!==null&&e!==void 0?e:[]},[l]),[u,Y]=a(),E=d(()=>g.find(e=>e.value===u),[g,u]);h(()=>{var e,n;Y((e=(n=g[0])===null||n===void 0?void 0:n.value)!==null&&e!==void 0?e:void 0)},[g]);const{data:I,loading:G}=z(u?`/embedding/tensor?${ue.stringify({name:u})}`:null),{data:N,loading:J}=z(u?`/embedding/metadata?${ue.stringify({name:u})}`:null),[ge,Q]=a(!1),[H,y]=a(!1),[F,w]=a("");h(()=>{H||w("")},[H]),h(()=>{F&&y(!0)},[F]),h(()=>{G&&(y(!0),w("fetching-tensor"))},[G]),h(()=>{J&&(y(!0),w("fetching-metadata"))},[J]);const[S,Z]=a(null),[ee,te]=a(null),fe=b(e=>{Z(e),te(null)},[]),[M,ve]=a(""),[ne,be]=a(""),[Ee,ye]=a(new Float32Array),[D,_e]=a([]),[A,oe]=a(),[ae,we]=a([]),[x,De]=a(0),[Ce,Pe]=a([0,0]),L=b(e=>{if(e!=null){const n=D.indexOf(e);if(n!==-1)return ae.map(c=>c[n])}return[]},[D,ae]),je=d(()=>L(A),[L,A]),[C,Se]=a("3d"),[f,Re]=a("pca"),Oe=d(()=>C==="3d",[C]),T=b((e,n,c)=>{if(n){y(!0),w(e);const r=new FileReader;r.readAsText(n,"utf-8"),r.onload=()=>{c(R=>{const j=r.result;return R===j&&y(!1),j})}}else c("")},[]);h(()=>T("reading-vector",S,ve),[S,T]),h(()=>T("reading-metadata",ee,be),[ee,T]),h(()=>Z(null),[u]);const B=b(e=>{X(e.message,{position:X.POSITION.TOP_CENTER,type:X.TYPE.ERROR}),st!=="production"&&console.error(e),y(!1)},[]),Ne=d(()=>{const e={maxCount:ct[f],maxDimension:dt[f]};return M?{from:"string",params:q({vectors:M,metadata:ne},e)}:E&&I?{from:"blob",params:q({shape:E.shape,vectors:I.data,metadata:N!=null?N:""},e)}:null},[f,M,E,I,ne,N]),ie=rt("high-dimensional/parse-data",Ne);h(()=>{const{error:e,data:n}=ie;e?B(e):n?(Pe(n.rawShape),De(n.dimension),ye(n.vectors),_e(n.labels),oe(n.labels[0]),we(n.metadata)):n!==null&&w("parsing")},[ie,B]);const le=d(()=>x!==0,[x]),k=d(()=>{var e;return S?S.name:(e=E==null?void 0:E.path)!==null&&e!==void 0?e:""},[S,E]),[$,Ae]=a(5),[V,Le]=a(10),[U,Te]=a(15),re=b(e=>{var n;Te(e),(n=i.current)===null||n===void 0||n.rerunUMAP()},[]),[m,se]=a(),Ie=b(()=>{se(void 0),w("calculating")},[]),He=b(e=>{se(e),y(!1)},[]),[v,Fe]=a({labelBy:void 0,value:""}),P=d(()=>{if(v.labelBy==null||v.value==="")return{indices:[],metadata:[]};const e=L(v.labelBy),n=[],c=[];for(let r=0;r<e.length;r++)e[r].includes(v.value)&&(n.push(e[r]),c.push(r));return{indices:c,metadata:n}},[L,v.labelBy,v.value]),[Me,xe]=a([]),ce=b(e=>xe(e==null?[]:[P.indices[e]]),[P.indices]),de=d(()=>{var e,n,c,r,R,j,W;switch(f){case"pca":return t.createElement(et,{dimension:C,variance:(e=m==null?void 0:m.variance)!==null&&e!==void 0?e:[],totalVariance:(n=m==null?void 0:m.totalVariance)!==null&&n!==void 0?n:0});case"tsne":return t.createElement(nt,{iteration:(c=m==null?void 0:m.step)!==null&&c!==void 0?c:0,perplexity:$,learningRate:V,onChangePerplexity:Ae,onChangeLearningRate:Le,onPause:(r=i.current)===null||r===void 0?void 0:r.pauseTSNE,onResume:(R=i.current)===null||R===void 0?void 0:R.resumeTSNE,onStop:(j=i.current)===null||j===void 0?void 0:j.pauseTSNE,onRerun:(W=i.current)===null||W===void 0?void 0:W.rerunTSNE});case"umap":return t.createElement(at,{neighbors:U,onRun:re});default:return null}},[f,C,m,$,V,U,re]),Be=d(()=>t.createElement(ht,null,t.createElement(O,null,t.createElement(mt,null,o("high-dimensional:data")),t.createElement(p,{label:o("high-dimensional:select-data")},t.createElement(he,{list:g,value:u,onChange:Y})),t.createElement(p,{label:o("high-dimensional:select-label")},t.createElement(he,{list:D,value:A,onChange:oe})),t.createElement(p,null,t.createElement(ut,{rounded:!0,outline:!0,type:"primary",onClick:()=>Q(!0)},o("high-dimensional:upload-data"))),t.createElement(p,null,k&&t.createElement("div",{className:"secondary"},o("high-dimensional:data-path"),o("common:colon"),k))),t.createElement(O,null,t.createElement(p,null,t.createElement(tt,{value:f,onChange:Re})),t.createElement(p,{label:o("high-dimensional:dimension")},t.createElement(Je,{value:C,onChange:Se})),de)),[o,k,f,C,D,A,g,u,de]),ke=d(()=>t.createElement(pt,null,t.createElement(O,null,t.createElement(p,null,t.createElement(qe,{labels:D,onChange:Fe})),v.value!==""&&t.createElement(p,{className:"secondary"},t.createElement("span",null,o("high-dimensional:matched-result-count",{count:P.metadata.length})))),t.createElement(O,{className:"search-result"},t.createElement(p,null,t.createElement(Ze,{list:P.metadata,onHovered:ce})))),[ce,D,v.value,P.metadata,o]);return t.createElement(t.Fragment,null,t.createElement(ot,null,o("common:high-dimensional")),H||s?t.createElement(ze,null,o(`high-dimensional:loading.${F}`)):null,t.createElement(gt,{aside:Be,leftAside:ke},le?t.createElement(We,{ref:i,vectors:Ee,labels:je,shape:Ce,dim:x,is3D:Oe,reduction:f,perplexity:$,learningRate:V,neighbors:U,focusedIndices:Me,highlightIndices:P.indices,onCalculate:Ie,onCalculated:He,onError:B}):t.createElement(Qe,null),t.createElement(it,{open:ge,hasVector:le,onClose:()=>Q(!1),onChangeVectorFile:fe,onChangeMetadataFile:te})))};export default ft;
