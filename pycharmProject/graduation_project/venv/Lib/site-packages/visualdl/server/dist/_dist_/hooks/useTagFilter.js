function x(e,n){if(e==null)return{};var s=C(e,n),t,r;if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)t=o[r],!(n.indexOf(t)>=0)&&(!Object.prototype.propertyIsEnumerable.call(e,t)||(s[t]=e[t]))}return s}function C(e,n){if(e==null)return{};var s={},t=Object.keys(e),r,o;for(o=0;o<t.length;o++)r=t[o],!(n.indexOf(r)>=0)&&(s[r]=e[r]);return s}function S(e,n){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);n&&(t=t.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),s.push.apply(s,t)}return s}function u(e){for(var n=1;n<arguments.length;n++){var s=arguments[n]!=null?arguments[n]:{};n%2?S(Object(s),!0).forEach(function(t){W(e,t,s[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):S(Object(s)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))})}return e}function W(e,n,s){return n in e?Object.defineProperty(e,n,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[n]=s,e}import{actions as k,selectors as I}from"../store/index.js";import{color as P,colorAlt as Q}from"../utils/chart.js";import{useCallback as q,useEffect as m,useMemo as f,useReducer as F}from"../../web_modules/react.js";import{useDispatch as G,useSelector as K}from"../../web_modules/react-redux.js";import{cache as L}from"../../web_modules/swr.js";import M from"../../web_modules/lodash/groupBy.js";import z from"../../web_modules/lodash/intersection.js";import H from"../../web_modules/lodash/intersectionBy.js";import J from"../../web_modules/lodash/uniq.js";import N from"./useQuery.js";import{useRunningRequest as U}from"./useRequest.js";var i;(function(e){e[e.initRuns=0]="initRuns",e[e.setRuns=1]="setRuns",e[e.setSelectedRuns=2]="setSelectedRuns",e[e.initTags=3]="initTags",e[e.setTags=4]="setTags",e[e.setSelectedTags=5]="setSelectedTags"})(i||(i={}));const j=(e,n)=>Object.entries(M(e.filter(s=>!!e.find(t=>t.label===s.label)).reduce((s,t)=>(n&&n[t.label]&&Array.prototype.push.apply(s,n[t.label].map(r=>({label:r,run:t}))),s),[]),s=>s.label)).map(([s,t])=>({label:s,runs:t.map(r=>r.run)})),V=e=>e==null?void 0:e.map((n,s)=>{const t=s%P.length;return{label:n,colors:[P[t],Q[t]]}}),X=(e,n)=>{switch(n.type){case i.initRuns:{const s=n.payload,t=s.length?z(s,e.globalRuns):e.globalRuns,r=t.length?t:s,o=V(s),b=o.filter(v=>r.includes(v.label)),y=j(b,e.initTags);return u(u({},e),{},{initRuns:s,globalRuns:r,runs:o,selectedRuns:b,tags:y,selectedTags:y})}case i.setRuns:{const s=n.payload,t=H(e.selectedRuns,s,o=>o.label),r=j(t,e.initTags);return u(u({},e),{},{runs:s,selectedRuns:t,tags:r,selectedTags:r})}case i.setSelectedRuns:{const s=n.payload,t=s.map(o=>o.label),r=j(s,e.initTags);return u(u({},e),{},{globalRuns:t,selectedRuns:s,tags:r,selectedTags:r})}case i.initTags:{const s=n.payload,t=j(e.selectedRuns,s);return u(u({},e),{},{initTags:s,tags:t,selectedTags:t})}case i.setTags:{const s=n.payload;return u(u({},e),{},{tags:s,selectedTags:s})}case i.setSelectedTags:{const s=n.payload;return u(u({},e),{},{selectedTags:s})}default:throw new Error}},Y=(e,n)=>{const s=N(),{data:t,loading:r,error:o}=U(`/${e}/tags`,n);m(()=>()=>L.delete(`/${e}/tags`),[e]);const b=G(),y=f(()=>I.runs.getRunsByPage(e),[e]),v=K(y),h=f(()=>{var l;return(l=t==null?void 0:t.runs)!==null&&l!==void 0?l:[]},[t]),d=f(()=>t?h.reduce((l,a,O)=>{if(l[a]){var g,p;l[a]=[...l[a],...(g=(p=t.tags)===null||p===void 0?void 0:p[O])!==null&&g!==void 0?g:[]]}else{var T;l[a]=(T=t.tags[O])!==null&&T!==void 0?T:[]}return l},{}):{},[h,t]),[c,R]=F(X,{initRuns:[],globalRuns:v,runs:[],selectedRuns:[],initTags:{},tags:[],selectedTags:[]}),w=f(()=>s.runs?J(Array.isArray(s.runs)?s.runs:s.runs.split(",")):[],[s]),D=q(l=>R({type:i.setSelectedRuns,payload:l}),[]),_=q(l=>R({type:i.setSelectedTags,payload:l}),[]);m(()=>R({type:i.initRuns,payload:h||[]}),[h]),m(()=>R({type:i.initTags,payload:d||{}}),[d]),m(()=>{if(w.length){const l=c.runs.filter(a=>w.includes(a.label));R({type:i.setSelectedRuns,payload:l.length?l:c.runs})}},[w,c.runs]),m(()=>{b(k.runs.setSelectedRuns(e,c.globalRuns))},[b,c.globalRuns,e]);const B=f(()=>c.tags.reduce((l,a)=>{let{runs:O}=a,g=x(a,["runs"]);return Array.prototype.push.apply(l,O.map(p=>u(u({},g),{},{run:p,id:`${g.label}-${p.label}`}))),l},[]),[c.tags]),E=f(()=>c.selectedRuns.filter(l=>{var a;return!!(d!=null&&(a=d[l.label])!==null&&a!==void 0&&a.length)}),[c.selectedRuns,d]);return u(u({},c),{},{tagsWithSingleRun:B,runsInTags:E,onChangeRuns:D,onChangeTags:_,loading:r,error:o})};export default Y;
