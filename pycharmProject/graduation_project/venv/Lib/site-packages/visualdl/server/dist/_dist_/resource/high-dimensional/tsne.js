function u(y,t,e){return t in y?Object.defineProperty(y,t,{value:e,enumerable:!0,configurable:!0,writable:!0}):y[t]=e,y}class M{constructor(){u(this,"returnV",!1),u(this,"vVal",0)}get value(){if(this.returnV)return this.returnV=!1,this.vVal;const t=2*Math.random()-1,e=2*Math.random()-1,i=t*t+e*e;if(i===0||i>1)return this.value;const s=Math.sqrt(-2*Math.log(i)/i);return this.vVal=e*s,this.returnV=!0,t*s}}export default class x{get solution(){return this.Y}get step(){return this.iter}constructor(t){var e,i;u(this,"dimension",void 0),u(this,"epsilon",10),u(this,"perplexity",30),u(this,"Random",new M),u(this,"data",new Float32Array),u(this,"P",new Float32Array),u(this,"Y",[]),u(this,"gains",[]),u(this,"yStep",[]),u(this,"D",0),u(this,"N",0),u(this,"iter",0),this.dimension=t.dimension,this.perplexity=(e=t.perplexity)!==null&&e!==void 0?e:this.perplexity,this.epsilon=(i=t.epsilon)!==null&&i!==void 0?i:this.epsilon}L2(t,e){if(t.length!==e.length)throw new Error("Cannot compare vectors with different length");const i=t.length;let s=0;for(let r=0;r<i;r++){const n=t[r],c=e[r];s+=(n-c)*(n-c)}return s}randn2d(t){const e=t!=null,i=[];for(let s=0;s<this.N;s++){const r=[];for(let n=0;n<this.dimension;n++)e?r.push(t):r.push(this.Random.value*1e-4);i.push(r)}return i}sliceDataRow(t){return this.data.slice(t*this.D,(t+1)*this.D)}xtod(){const t=new Float32Array(this.N*this.N);for(let e=0;e<this.N;e++)for(let i=0;i<this.N;i++){const s=this.L2(this.sliceDataRow(e),this.sliceDataRow(i));t[e*this.N+i]=s,t[i*this.N+e]=s}return t}d2p(t,e=1e-4){const i=Math.sqrt(t.length),s=Math.floor(i);if(i!==s)throw new Error("Distance is not a square matrix");const r=Math.log(this.perplexity),n=new Float32Array(s*s),c=new Float32Array(s);for(let h=0;h<s;h++){let f=Number.NEGATIVE_INFINITY,o=Number.POSITIVE_INFINITY,a=1;const d=50;let g=0;for(;g<d;){let l=0;for(let p=0;p<s;p++){let w=Math.exp(-t[h*s+p]*a);h===p&&(w=0),c[p]=w,l+=w}let I=0;for(let p=0;p<s;p++){const w=l===0?0:c[p]/l;c[p]=w,w>1e-7&&(I-=w*Math.log(w))}if(I>r?(f=a,o===Number.POSITIVE_INFINITY?a*=2:a=(a+o)/2):(o=a,f===Number.NEGATIVE_INFINITY?a/=2:a=(a+f)/2),g++,Math.abs(I-r)<e)break}for(let l=0;l<s;l++)n[h*s+l]=c[l]}const N=new Float32Array(s*s),m=s*2;for(let h=0;h<s;h++)for(let f=0;f<s;f++)N[h*s+f]=Math.max((n[h*s+f]+n[f*s+h])/m,Number.EPSILON);return N}costGrad(){const t=this.Y,e=this.N,i=this.dimension,s=this.P,r=e*e,n=this.iter<100?4:1,c=new Float32Array(r);let N=0;for(let o=0;o<e;o++)for(let a=o+1;a<e;a++){let d=0;for(let l=0;l<i;l++){const I=t[o][l]-t[a][l];d+=I*I}const g=1/(1+d);c[o*e+a]=g,c[a*e+o]=g,N+=2*g}const m=new Float32Array(r);for(let o=0;o<r;o++)m[o]=Math.max(c[o]/N,Number.EPSILON);let h=0;const f=[];for(let o=0;o<e;o++){const a=Array.from({length:i}).fill(0);for(let d=0;d<e;d++){h+=-s[o*e+d]*Math.log(m[o*e+d]);const g=4*(n*s[o*e+d]-m[o*e+d])*c[o*e+d];for(let l=0;l<i;l++)a[l]+=g*(t[o][l]-t[d][l])}f.push(a)}return{cost:h,grad:f}}setData(t,e){if(t.length&&e&&t.length%e!=0)throw Error("Wrong data shape");if(t.length===0||e===0)return;this.data=t,this.D=e,this.N=t.length/e;const i=this.xtod();this.P=this.d2p(i),this.Y=this.randn2d(),this.gains=this.randn2d(1),this.yStep=this.randn2d(0),this.iter=0}setPerplexity(t){this.perplexity=t}setEpsilon(t){this.epsilon=t}run(){this.iter++;const t=this.N,{cost:e,grad:i}=this.costGrad(),s=new Float32Array(this.dimension);for(let r=0;r<t;r++)for(let n=0;n<this.dimension;n++){const c=i[r][n],N=this.yStep[r][n],m=this.gains[r][n];let h=Math.sign(c)===Math.sign(N)?m*.8:m+.2;h<.01&&(h=.01),this.gains[r][n]=h;const o=(this.iter<250?.5:.8)*N-this.epsilon*h*i[r][n];this.yStep[r][n]=o,this.Y[r][n]+=o,s[n]+=this.Y[r][n]}for(let r=0;r<t;r++)for(let n=0;n<this.dimension;n++)this.Y[r][n]-=s[n]/t;return e}}
