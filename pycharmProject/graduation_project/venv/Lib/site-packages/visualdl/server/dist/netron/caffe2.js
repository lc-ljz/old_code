var caffe2=caffe2||{},protobuf=protobuf||require("./protobuf");caffe2.ModelFactory=class{match(t){const e=t.identifier.toLowerCase(),n=e.split(".").pop().toLowerCase();if(n=="pb"){if(e.endsWith("predict_net.pb")||e.endsWith("init_net.pb")||e.startsWith("predict_net")||e.startsWith("init_net"))return!0;const i=t.tags("pb");if(i.size>0&&i.has(1)&&i.get(1)==0&&i.has(2)&&i.get(2)==0&&i.has(9)&&i.get(9)==2||i.size>0&&Array.from(i.values()).some(r=>r===5))return!1;if(!(!(i.size>0)||i.has(1)&&i.get(1)!==2||i.has(2)&&i.get(2)!==2||i.has(7)&&i.get(7)!==2||i.has(8)&&i.get(8)!==2)){const r=t.buffer;if(r.length>3&&r[0]==10){const c=r[1];if(c<64&&r.length>2+c+1&&r.slice(2,2+c).every(l=>l>=32&&l<=127)&&r[2+c]==18)return!0}if(r.length>3&&r[0]==18)return!0}}if(n=="pbtxt"||n=="prototxt"){if(e.endsWith("predict_net"))return!0;if(t.tags("pbtxt").has("op"))return t.identifier!=="ops.pbtxt"||t.text.indexOf("  attr {")===-1}return!1}open(t,e){return e.require("./caffe2-proto").then(()=>caffe2.Metadata.open(e).then(n=>{const i=t.identifier,r=i.split("."),c=r.pop().toLowerCase(),l=r.join(".");if(c=="pbtxt"||c=="prototxt"){const h=(s,o)=>{let a=null,p=null;try{caffe2.proto=protobuf.get("caffe2").caffe2;const u=protobuf.TextReader.create(s);u.field=function(f,_){if(!(_ instanceof caffe2.proto.DeviceOption))throw new Error("Unknown field '"+f+"'"+this.location());_[f]=this.skip()},a=caffe2.proto.NetDef.decodeText(u)}catch(u){throw new caffe2.Error("File text format is not caffe2.NetDef ("+u.message+") in '"+i+"'.")}try{caffe2.proto=protobuf.get("caffe2").caffe2,p=typeof o=="string"?caffe2.proto.NetDef.decodeText(protobuf.TextReader.create(o)):caffe2.proto.NetDef.decode(protobuf.Reader.create(o))}catch(u){}try{return new caffe2.Model(n,a,p)}catch(u){e.exception(u,!1);const f=u&&u.message?u.message:u.toString();throw new caffe2.Error(f.replace(/\.$/,"")+" in '"+i+"'.")}};return l.toLowerCase().endsWith("init_net")||l.toLowerCase().startsWith("init_net")?t.request(i.replace("init_net","predict_net"),"utf-8").then(s=>h(s,t.text)).catch(()=>h(t.text,null)):l.toLowerCase().endsWith("predict_net")||l.toLowerCase().startsWith("predict_net")?t.request(i.replace("predict_net","init_net").replace(/\.pbtxt/,".pb"),null).then(s=>h(t.text,s)).catch(()=>t.request(i.replace("predict_net","init_net"),"utf-8").then(s=>h(t.text,s)).catch(()=>h(t.text,null))):t.request(l+"_init.pb",null).then(s=>h(t.text,s)).catch(()=>h(t.text,null))}{const h=(s,o)=>{let a=null,p=null;try{caffe2.proto=protobuf.get("caffe2").caffe2;const u=protobuf.Reader.create(s);a=caffe2.proto.NetDef.decode(u)}catch(u){throw new caffe2.Error("File format is not caffe2.NetDef ("+u.message+") in '"+i+"'.")}try{if(o){caffe2.proto=protobuf.get("caffe2").caffe2;const u=protobuf.Reader.create(o);p=caffe2.proto.NetDef.decode(u)}}catch(u){}try{return new caffe2.Model(n,a,p)}catch(u){e.exception(u,!1);const f=u&&u.message?u.message:u.toString();throw new caffe2.Error(f.replace(/\.$/,"")+" in '"+i+"'.")}};return l.toLowerCase().endsWith("init_net")?t.request(l.replace(/init_net$/,"")+"predict_net."+c,null).then(s=>h(s,t.buffer)).catch(()=>h(t.buffer,null)):l.toLowerCase().endsWith("_init")?t.request(l.replace(/_init$/,"")+"."+c,null).then(s=>h(s,t.buffer)).catch(()=>h(t.buffer,null)):l.toLowerCase().endsWith("predict_net")||l.toLowerCase().startsWith("predict_net")?t.request(i.replace("predict_net","init_net"),null).then(s=>h(t.buffer,s)).catch(()=>h(t.buffer,null)):t.request(l+"_init."+c,null).then(s=>h(t.buffer,s)).catch(()=>h(t.buffer,null))}}))}},caffe2.Model=class{constructor(t,e,n){this._domain=e.domain||null;const i=new caffe2.Graph(t,e,n);this._graphs=[i]}get format(){return"Caffe2"}get domain(){return this._domain}get graphs(){return this._graphs}},caffe2.Graph=class{constructor(t,e,n){this._name=e.name||"",this._type=e.type||"",this._nodes=[];const i=new Map;for(const s of e.external_input)i.set(s,{});if(n){for(const s of n.op)if(s.output&&s.output.length==1){const o=s.output[0];i.has(o)||i.set(o,{});const a=i.get(o);for(const p of s.arg)a[p.name]=p;switch(s.type){case"GivenTensorFill":a.dataType="float32";break;case"GivenTensorDoubleFill":a.dataType="float64";break;case"GivenTensorBoolFill":a.dataType="boolean";break;case"GivenTensorByteStringToUInt8Fill":a.dataType="uint8";break;case"GivenTensorInt16Fill":case"GivenTensorSInt16Fill":a.dataType="int16";break;case"GivenTensorIntFill":a.dataType="int32";break;case"GivenTensorInt64Fill":a.dataType="int64";break;case"GivenTensorStringFill":a.dataType="string";break;case"Int8GivenIntTensorFill":a.dataType="int32";break;case"Int8GivenTensorFill":a.dataType="int8";break;case"XavierFill":case"ConstantFill":break;default:throw new caffe2.Error("Unknown init op '"+s.type+"'.")}a.values&&a.values.floats&&(a.values.floats.length!==1||a.values.floats[0]!==0)&&(a.input=!1)}}const r={};let c=0;for(const s of e.op)s.input=s.input.map(o=>r[o]?r[o]:o),s.output=s.output.map(o=>{if(r[o]){const a=o+`
`+c.toString();return r[o]=a,a}return r[o]=o,o}),c++;let l=null,h=null;for(const s of e.op){const o=new caffe2.Node(t,s,i);s.input.length==1&&s.output.length>=1&&s.input[0].split(`
`).shift()==s.output[0].split(`
`).shift()&&l&&h==s.input[0].split(`
`).shift()?l.chain.push(o):(this._nodes.push(o),l=null,h=null,s.output.length==1&&(l=o,h=s.output[0].split(`
`).shift()))}this._inputs=[];for(const s of e.external_input){if(e.external_input.length>1){const o=i.get(s);if(o&&o.input===!1)continue}this._inputs.push(new caffe2.Parameter(s,[new caffe2.Argument(s,null,null)]))}this._outputs=[];for(const s of e.external_output)this._outputs.push(new caffe2.Parameter(s,[new caffe2.Argument(s,null,null)]))}get name(){return this._name}get type(){return this._type}get inputs(){return this._inputs}get outputs(){return this._outputs}get nodes(){return this._nodes}toString(){return"graph("+this.name+")"}},caffe2.Parameter=class{constructor(t,e){this._name=t,this._arguments=e}get name(){return this._name}get visible(){return!0}get arguments(){return this._arguments}},caffe2.Argument=class{constructor(t,e,n){if(typeof t!="string")throw new caffe2.Error("Invalid argument identifier '"+JSON.stringify(t)+"'.");this._name=t,this._type=e||null,this._initializer=n||null}get name(){return this._name}get type(){return this._initializer?this._initializer.type:this._type}get quantization(){return this._initializer?this._initializer.quantization:null}get initializer(){return this._initializer}},caffe2.Node=class{constructor(t,e,n){this._name=e.name||"",this._device=e.engine||"",this._metadata=t,this._type=e.type,this._chain=[],this._attributes=[];for(const a of e.arg)this._attributes.push(new caffe2.Attribute(t,t.attribute(this._type,a.name),a));const i=t.type(this._type),r=e.input,c=e.output,l={};let h=0;for(const a of r){if(h>0&&n.has(a)){const p=n.get(a);l[a]=new caffe2.Tensor(a,p),p.input=!1}h++}for(const a of c)n.has(a)&&(n.get(a).input=!1);this._inputs=[];let s=0;if(i&&i.inputs){for(const a of i.inputs)if(s<r.length||a.option!="optional"){const p=a.option=="variadic"?r.length-s:1,u=r.slice(s,s+p).filter(f=>f!=""||a.option!="optional").map(f=>new caffe2.Argument(f,null,l[f]));this._inputs.push(new caffe2.Parameter(a.name,u)),s+=p}}else this._inputs=this._inputs.concat(r.slice(s).map((a,p)=>{const u=s+p==0?"input":(s+p).toString();return new caffe2.Parameter(u,[new caffe2.Argument(a,null,l[a])])}));this._outputs=[];let o=0;if(i&&i.outputs){for(const a of i.outputs)if(o<c.length||a.option!="optional"){const p=a.option=="variadic"?c.length-o:1,u=c.slice(o,o+p).map(f=>new caffe2.Argument(f));this._outputs.push(new caffe2.Parameter(a.name,u)),o+=p}}else this._outputs=this._outputs.concat(c.slice(o).map((a,p)=>{const u=o+p==0?"output":(o+p).toString();return new caffe2.Parameter(u,[new caffe2.Argument(a,null,null)])}))}get name(){return this._name||""}get device(){return this._device||""}get type(){return this._type}get metadata(){return this._metadata.type(this._type)}get inputs(){return this._inputs}get outputs(){return this._outputs}get attributes(){return this._attributes}get chain(){return this._chain}},caffe2.Attribute=class{constructor(t,e,n){if(this._name=n.name,n.floats&&n.floats.length>0?this._value=n.floats:n.ints&&n.ints.length>0?this._value=n.ints:n.nets&&n.nets.length>0?(this._value=n.nets.map(i=>new caffe2.Graph(t,i,null)),this._type="graph[]"):n.n?(this._value=new caffe2.Graph(t,n.n,null),this._type="graph"):(n.i,this._value=n.i),e&&Object.prototype.hasOwnProperty.call(e,"type")&&(this._type=e.type,this._type=="boolean"))switch(this._value){case 1:this._value=!0;break;case 0:this._value=!1}e&&(Object.prototype.hasOwnProperty.call(e,"visible")&&!e.visible||Object.prototype.hasOwnProperty.call(e,"default")&&(this._value==e.default||this._value&&this._value.toString()==e.default.toString()))&&(this._visible=!1)}get name(){return this._name}get type(){return this._type||null}get value(){return this._value}get visible(){return this._visible!=0}},caffe2.Tensor=class{constructor(t,e){this._name=t;const n=e.shape&&e.shape.ints?e.shape.ints:null;this._type=new caffe2.TensorType(e.dataType,new caffe2.TensorShape(n)),this._values=e.values||null,this._scale=e.Y_scale?e.Y_scale.f:0,this._zeroPoint=e.Y_zero_point?e.Y_zero_point.i:0}get name(){return this._name}get type(){return this._type}get kind(){return"Initializer"}get quantization(){return this._scale!=0||this._zeroPoint!=0?this._scale.toString()+" * "+(this._zeroPoint==0?"q":"(q - "+this._zeroPoint.toString()+")"):null}get state(){return this._context().state}get value(){const t=this._context();return t.state?null:(t.limit=Number.MAX_SAFE_INTEGER,this._decode(t,0))}toString(){const t=this._context();if(t.state)return"";t.limit=1e4;const e=this._decode(t,0);return caffe2.Tensor._stringify(e,"","    ")}_context(){const t={state:null,index:0,count:0};if(!this._values)return t.state="Tensor data is empty.",t;if(this._values.floats===void 0)return t.state="Tensor data is too large to load in Chrome.",t;switch(this._type.dataType){case"float32":t.data=this._values.floats;break;case"boolean":t.data=this._values.ints;break;case"int8":t.data=new Int8Array(this._values.s);break;case"int32":t.data=this._values.ints;break;default:return t.state="Unknown data type.",t}return t.shape=this._type.shape.dimensions,t.dataType=this._type.dataType,t}_decode(t,e){const n=[],i=t.shape[e];if(e==t.shape.length-1)for(let r=0;r<i;r++){if(t.count>t.limit)return n.push("..."),n;switch(t.dataType){case"float32":n.push(t.data[t.index]);break;case"boolean":n.push(t.data[t.index]!=0);break;case"int8":case"int32":n.push(t.data[t.index]);break;default:t.state="Unknown data type."}t.index++,t.count++}else for(let r=0;r<i;r++){if(t.count>t.limit)return n.push("..."),n;n.push(this._decode(t,e+1))}return n}static _stringify(t,e,n){if(Array.isArray(t)){const i=[];i.push(e+"[");const r=t.map(c=>caffe2.Tensor._stringify(c,e+n,n));return r.length>0&&i.push(r.join(`,
`)),i.push(e+"]"),i.join(`
`)}return typeof t=="string"?e+t:t==1/0?e+"Infinity":t==-1/0?e+"-Infinity":isNaN(t)?e+"NaN":e+t.toString()}},caffe2.TensorType=class{constructor(t,e){this._dataType=t,this._shape=e}get dataType(){return this._dataType||"?"}get shape(){return this._shape}toString(){return this.dataType+this._shape.toString()}},caffe2.TensorShape=class{constructor(t){this._dimensions=t}get dimensions(){return this._dimensions}toString(){return this._dimensions?"["+this._dimensions.map(t=>t.toString()).join(",")+"]":""}},caffe2.Metadata=class{static open(t){return caffe2.Metadata._metadata?Promise.resolve(caffe2.Metadata._metadata):t.request(null,"caffe2-metadata.json","utf-8").then(e=>(caffe2.Metadata._metadata=new caffe2.Metadata(e),caffe2.Metadata._metadata)).catch(()=>(caffe2.Metadata._metadata=new caffe2.Metadata(null),caffe2.Metadata._metadata))}constructor(t){if(this._map={},this._attributeCache={},t){const e=JSON.parse(t);if(e)for(const n of e)n.name&&n.schema&&(n.schema.name=n.name,this._map[n.name]=n.schema)}}type(t){return this._map[t]||null}attribute(t,e){let n=this._attributeCache[t];if(!n){n={};const i=this.type(t);if(i&&i.attributes&&i.attributes.length>0)for(const r of i.attributes)n[r.name]=r;this._attributeCache[t]=n}return n[e]||null}},caffe2.Error=class extends Error{constructor(t){super(t),this.name="Error loading Caffe2 model."}},typeof module!="undefined"&&typeof module.exports=="object"&&(module.exports.ModelFactory=caffe2.ModelFactory);
