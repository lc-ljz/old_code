var dl4j=dl4j||{},long=long||{Long:require("long")};dl4j.ModelFactory=class{match(e){return!!(e.identifier.toLowerCase().split(".").pop().toLowerCase()==="zip"&&e.entries("zip").length>0&&dl4j.ModelFactory._openContainer(e))}open(e,t){const n=e.identifier;try{const r=dl4j.ModelFactory._openContainer(e),a=JSON.parse(r.configuration);return dl4j.Metadata.open(t).then(i=>{try{return new dl4j.Model(i,a,r.coefficients)}catch(s){t.exception(s,!1);const o=s&&s.message?s.message:s.toString();throw new dl4j.Error(o.replace(/\.$/,"")+" in '"+n+"'.")}})}catch(r){t.exception(r,!1);const a=r&&r.message?r.message:r.toString();return Promise.reject(new dl4j.Error(a.replace(/\.$/,"")+" in '"+n+"'."))}}static _openContainer(e){const t=e.entries("zip"),n=t.filter(i=>i.name==="configuration.json");if(n.length!=1)return null;let r=null;try{r=new TextDecoder("utf-8").decode(n[0].data)}catch(i){return null}if(r.indexOf('"vertices"')===-1&&r.indexOf('"confs"')===-1)return null;const a=t.filter(i=>i.name==="coefficients.bin");return a.length>1?null:{configuration:r,coefficients:a.length==1?a[0].data:[]}}},dl4j.Model=class{constructor(e,t,n){this._graphs=[],this._graphs.push(new dl4j.Graph(e,t,n))}get format(){return"Deeplearning4j"}get graphs(){return this._graphs}},dl4j.Graph=class{constructor(e,t,n){this._inputs=[],this._outputs=[],this._nodes=[];const r=new dl4j.NDArrayReader(n).dataType;if(t.networkInputs)for(const i of t.networkInputs)this._inputs.push(new dl4j.Parameter(i,!0,[new dl4j.Argument(i,null,null)]));if(t.networkOutputs)for(const i of t.networkOutputs)this._outputs.push(new dl4j.Parameter(i,!0,[new dl4j.Argument(i,null,null)]));let a=null;if(t.vertices)for(const i in t.vertices){const s=dl4j.Node._object(t.vertices[i]);a=t.vertexInputs[i];let o=[],u=null;switch(s.__type__){case"LayerVertex":u=dl4j.Node._object(s.layerConf.layer),o=s.layerConf.variables;break;case"MergeVertex":u={__type__:"Merge",layerName:i};break;case"ElementWiseVertex":u={__type__:"ElementWise",layerName:i,op:s.op};break;case"PreprocessorVertex":u={__type__:"Preprocessor",layerName:i};break;default:throw new dl4j.Error("Unsupported vertex class '"+s["@class"]+"'.")}this._nodes.push(new dl4j.Node(e,u,a,r,o))}if(t.confs){a=["input"],this._inputs.push(new dl4j.Parameter("input",!0,[new dl4j.Argument("input",null,null)]));for(const i of t.confs){const s=dl4j.Node._object(i.layer);this._nodes.push(new dl4j.Node(e,s,a,r,i.variables)),a=[s.layerName]}this._outputs.push(new dl4j.Parameter("output",!0,[new dl4j.Argument(a[0],null,null)]))}}get inputs(){return this._inputs}get outputs(){return this._outputs}get nodes(){return this._nodes}},dl4j.Parameter=class{constructor(e,t,n){this._name=e,this._visible=t,this._arguments=n}get name(){return this._name}get visible(){return this._visible}get arguments(){return this._arguments}},dl4j.Argument=class{constructor(e,t,n){if(typeof e!="string")throw new dl4j.Error("Invalid argument identifier '"+JSON.stringify(e)+"'.");this._name=e,this._type=t,this._initializer=n}get name(){return this._name}get type(){return this._initializer?this._initializer.type:this._type}get initializer(){return this._initializer}},dl4j.Node=class{constructor(e,t,n,r,a){if(this._metadata=e,this._type=t.__type__,this._name=t.layerName||"",this._inputs=[],this._outputs=[],this._attributes=[],n&&n.length>0){const s=n.map(o=>new dl4j.Argument(o,null,null));this._inputs.push(new dl4j.Parameter(s.length<2?"input":"inputs",!0,s))}if(a)for(const s of a){let o=null;switch(this._type){case"Convolution":switch(s){case"W":o=new dl4j.Tensor(r,t.kernelSize.concat([t.nin,t.nout]));break;case"b":o=new dl4j.Tensor(r,[t.nout]);break;default:throw new dl4j.Error("Unknown '"+this._type+"' variable '"+s+"'.")}break;case"SeparableConvolution2D":switch(s){case"W":o=new dl4j.Tensor(r,t.kernelSize.concat([t.nin,t.nout]));break;case"pW":o=new dl4j.Tensor(r,[t.nout]);break;default:throw new dl4j.Error("Unknown '"+this._type+"' variable '"+s+"'.")}break;case"Output":case"Dense":switch(s){case"W":o=new dl4j.Tensor(r,[t.nout,t.nin]);break;case"b":o=new dl4j.Tensor(r,[t.nout]);break;default:throw new dl4j.Error("Unknown '"+this._type+"' variable '"+s+"'.")}break;case"BatchNormalization":o=new dl4j.Tensor(r,[t.nin]);break;default:throw new dl4j.Error("Unknown '"+this._type+"' variable '"+s+"'.")}this._inputs.push(new dl4j.Parameter(s,!0,[new dl4j.Argument(s,null,o)]))}this._name&&this._outputs.push(new dl4j.Parameter("output",!0,[new dl4j.Argument(this._name,null,null)]));let i=t;if(t.activationFn){const s=dl4j.Node._object(t.activationFn);s.__type__!=="ActivationIdentity"&&s.__type__!=="Identity"&&(s.__type__.startsWith("Activation")&&(s.__type__=s.__type__.substring("Activation".length)),this._type=="Activation"?(this._type=s.__type__,i=s):(this._chain=this._chain||[],this._chain.push(new dl4j.Node(e,s,[],null,null))))}for(const s in i){switch(s){case"__type__":case"constraints":case"layerName":case"activationFn":case"idropout":case"hasBias":continue}this._attributes.push(new dl4j.Attribute(e.attribute(this._type,s),s,i[s]))}if(t.idropout&&dl4j.Node._object(t.idropout).p!==1)throw new dl4j.Error("Layer 'idropout' not implemented.")}get type(){return this._type}get name(){return this._name}get metadata(){return this._metadata.type(this._type)}get inputs(){return this._inputs}get outputs(){return this._outputs}get attributes(){return this._attributes}get chain(){return this._chain}static _object(e){let t={};if(e["@class"]){t=e;let n=e["@class"].split(".").pop();n.endsWith("Layer")&&(n=n.substring(0,n.length-5)),delete e["@class"],t.__type__=n}else{let n=Object.keys(e)[0];t=e[n],n.length>0&&(n=n[0].toUpperCase()+n.substring(1)),t.__type__=n}return t}},dl4j.Attribute=class{constructor(e,t,n){this._name=t,this._value=n,this._visible=!1,e&&e.visible&&(this._visible=!0)}get name(){return this._name}get type(){return this._type}get value(){return this._value}get visible(){return this._visible}},dl4j.Tensor=class{constructor(e,t){this._type=new dl4j.TensorType(e,new dl4j.TensorShape(t))}get type(){return this._type}get state(){return"Not implemented."}},dl4j.TensorType=class{constructor(e,t){this._dataType=e,this._shape=t}get dataType(){return this._dataType}get shape(){return this._shape}toString(){return(this.dataType||"?")+this._shape.toString()}},dl4j.TensorShape=class{constructor(e){this._dimensions=e}get dimensions(){return this._dimensions}toString(){return this._dimensions?this._dimensions.length==0?"":"["+this._dimensions.map(e=>e.toString()).join(",")+"]":""}},dl4j.Metadata=class{static open(e){return dl4j.Metadata.textDecoder=dl4j.Metadata.textDecoder||new TextDecoder("utf-8"),dl4j.Metadata._metadata?Promise.resolve(dl4j.Metadata._metadata):e.request(null,"dl4j-metadata.json","utf-8").then(t=>(dl4j.Metadata._metadata=new dl4j.Metadata(t),dl4j.Metadata._metadata)).catch(()=>(dl4j.Metadata._metadata=new dl4j.Metadata(null),dl4j.Metadata._metadata))}constructor(e){if(this._map={},this._attributeCache={},e&&e){const t=JSON.parse(e);if(t)for(const n of t)n.schema.name=n.name,this._map[n.name]=n.schema}}type(e){return this._map[e]}attribute(e,t){let n=this._attributeCache[e];if(!n){n={};const r=this.type(e);if(r&&r.attributes&&r.attributes.length>0)for(const a of r.attributes)n[a.name]=a;this._attributeCache[e]=n}return n[t]||null}},dl4j.NDArrayReader=class{constructor(e){const t=new dl4j.BinaryReader(e);dl4j.NDArrayReader._header(t);const n=dl4j.NDArrayReader._header(t);this._dataType=n.type}get dataType(){return this._dataType}static _header(e){const t={};switch(t.alloc=e.string(),t.length=0,t.alloc){case"DIRECT":case"HEAP":case"JAVACPP":t.length=e.int32();break;case"LONG_SHAPE":case"MIXED_DATA_TYPES":t.length=e.int64()}switch(t.type=e.string(),t.type){case"INT":t.type="int32",t.itemsize=4;break;case"FLOAT":t.type="float32",t.itemsize=4}return t.data=e.bytes(t.itemsize*t.length),t}},dl4j.BinaryReader=class{constructor(e){this._buffer=e,this._position=0}bytes(e){const t=this._buffer.subarray(this._position,this._position+e);return this._position+=e,t}string(){const e=this._buffer[this._position++]<<8|this._buffer[this._position++],t=this.bytes(e);return new TextDecoder("ascii").decode(t)}int32(){return this._buffer[this._position++]<<24|this._buffer[this._position++]<<16|this._buffer[this._position++]<<8|this._buffer[this._position++]}int64(){const e=this.int32(),t=this.int32();return new long.Long(e,t,!0).toNumber()}},dl4j.Error=class extends Error{constructor(e){super(e),this.name="Error loading Deeplearning4j model."}},typeof module!="undefined"&&typeof module.exports=="object"&&(module.exports.ModelFactory=dl4j.ModelFactory);
