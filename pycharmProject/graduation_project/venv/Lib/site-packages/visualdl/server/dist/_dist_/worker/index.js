import m from"../../__snowpack__/env.js";import.meta.env=m;function s(i,e,t){return e in i?Object.defineProperty(i,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):i[e]=t,i}import{callListener as r,checkWorkerModuleSupport as h,pushFunctionToListener as n,removeFunctionFromListener as o,runner as l}from"./utils.js";import a from"../../web_modules/eventemitter3.js";const c=import.meta.env.SNOWPACK_PUBLIC_BASE_URI;export default class u{constructor(e){s(this,"listeners",{}),s(this,"onceListeners",{}),s(this,"worker",null),s(this,"emitter",null),s(this,"env",import.meta.env);const t=`${c}/_dist_/worker`;h()?(this.worker=new Worker(`${t}/worker.js`,{type:"module"}),this.worker.addEventListener("message",this.listener.bind(this)),this.emit("INITIALIZE",{name:e,env:import.meta.env})):(this.emitter=new a,this.emitter.addListener("message",this.listener.bind(this)),window.setTimeout(()=>{l(e,this)},200))}listener(e){r.call(this,this.onceListeners,e.data),r.call(this,this.listeners,e.data),delete this.onceListeners[e.data.type]}emit(e,t){this.worker?this.worker.postMessage({type:e,data:t}):this.emitter&&this.emitter.emit("message",{data:{type:e,data:t}})}on(e,t){n(this.listeners,e,t)}off(e,t){o(this.listeners,e,t),o(this.onceListeners,e,t)}once(e,t){n(this.onceListeners,e,t)}terminate(){this.worker&&this.worker.terminate()}}
